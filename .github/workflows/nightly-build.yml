name: Create Nightly Build

on:
  schedule:
    - cron: '0 20 * * 1-5'
  release:
    types: [prereleased, released]
 
jobs:
  Create-Nightly-Build:
    runs-on: ubuntu-latest
    env:
      RUNNER_IMAGE: "constellationapplication/netbeans-runner:12.0.4"
    container:
      image: docker://pandoc/latex:2.9
      options: --entrypoint=bash
    steps:
      - name: Update GH Actions Tools 
        run: |
          apk update && apk upgrade && apk add --no-cache coreutils && apk add bash && apk add docker && apk add git
      - name: Create Workspace Dir for operations
        run: |
              mkdir -p ./workspace
      - name: Checkout Constellation repository
        uses: actions/checkout@v2
        with:
          repository: constellation-app/constellation
          path: ./workspace/constellation
      - name: Checkout Constellation Adaptors repository
        uses: actions/checkout@v2
        with:
          repository: constellation-app/constellation-adaptors
          path: ./workspace/constellation-adaptors
      - name: Checkout Constellation Applications repository
        uses: actions/checkout@v2
        with:
          repository: constellation-app/constellation-applications
          path: ./workspace/constellation-applications
      - name: add execute priveledge to scripts
        run: |
              chmod +x ./workspace/constellation-applications/build-zip.sh && chmod +x ./workspace/constellation-applications/functions.sh
      - name: Run build process within Docker container
        run: |
            docker pull "${RUNNER_IMAGE}" && docker run -e GIT_DISCOVERY_ACROSS_FILESYSTEM=1 --mount "type=bind,source=/,target=/home/runner/work/constellation" --workdir /home/runner/work/constellation/home/runner/work/constellation/constellation/workspace/constellation-applications constellationapplication/netbeans-runner:12 ./build-zip.sh -a constellation -m "constellation constellation-adaptors"
      - name: Upload Linux Build
        uses: actions/upload-artifact@v2.3.0
        with:
          name: Linux Nightly Build
          path: ./workspace/constellation-applications/constellation/dist/constellation-linux**
          retention-days: 2
      - name: Upload MacOS Build
        uses: actions/upload-artifact@v2.3.0
        with:
          name: MacOSX Nightly Build
          path: ./workspace/constellation-applications/constellation/dist/constellation-macosx**
          retention-days: 2
      - name: Upload Windows Build
        uses: actions/upload-artifact@v2.3.0
        with:
          name: Windows Nightly Build
          path: ./workspace/constellation-applications/constellation/dist/constellation-win**.zip
          retention-days: 2
