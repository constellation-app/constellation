before_cache:
  - find "${HOME}"/.ivy2/cache -name "ivydata-*.properties" -print -delete
cache:
  directories:
    - ${HOME}/.ivy2/cache

env:
  - builder_image="constellationapplication/netbeans-builder:latest"

jobs:
  include:

  - stage: Run Tests
    dist: trusty
    language: generic
    services:
      - docker
    script:
      - docker pull "${builder_image}"
      - docker run -v $(pwd):/workdir/ -v "${HOME}"/.ivy2/cache:/root/.ivy2/cache --workdir /workdir/ "${builder_image}" .travis/run-tests.sh
      - sonar-scanner -Dsonar.pullrequest.key=${TRAVIS_PULL_REQUEST} -Dsonar.pullrequest.base=${TRAVIS_BRANCH} -Dsonar.pullrequest.provider=github
    addons:
      sonarcloud:
        organization: "constellation"
        token:
          secure: "AjRVndWZPE0NFtcZHmIN+wdKSA191LxItRlARIbiixh48uuxcbPAcNUQsMzEwlHlwUMrpzTw3Oym7m3fMFqXqv7NAic6lIk3vgBF6Wk+L/fvAf40AH0quJRyzvufW3EzSxi0IOcPzy9U3VCFZk9J7Dv28G6OTMp/nlI0X3+1U7IqKCe9gxWjzEcQzz0GZyPtbPDuPZQmpwyXPLuFIR3W2G8WwNGgLX5J1YVb3KOjx4mPkCHHzBRDjLJJ9DhiIRlBb5NMj1sH4JwQ5pUtOfmAMM0z+QOhsj21wFKmBXBSc2acgRHJe472F3SEmviNbX4j722y4RxKMNj/3aatEL1T14uc/VLxCGhbM2t1a2pzIXYARRCMyjZcugx6T/N7ry1X8s/ZWmIMYCn2Go9LeXRasTbAItRO2glqgeb7l2hJefkmq7MmJF/8Pgc+VX/qzFrsJJ0OkLu0/D9pwUpcLRup8v1os4Iyt1WFd4Hlivf7fBDTBcEIxvYpPqaeX5GUT7+sZd2DmLVfNzpzf35DgNxnhGUeAPJA1DTRFBeFqvCd7qCR0wwSdwk1NI3rueZaVNYCRw8MNtaGoz5LHXr/nZs05qwT8RFrHvLETqddNFxgi+TLZVpYksevzUAe16xT6jg4vWb/82Kg9I2OWAJmPomZONoebiggfblICNJdgncWJhE="
    script:
      - sonar-scanner

  - stage: Build zip
    dist: trusty
    language: generic
    services:
      - docker
    script:
      - docker pull "${builder_image}"
      - docker run -v "$(pwd):/workdir/" -v "${HOME}"/.ivy2/cache:/root/.ivy2/cache --workdir /workdir/ "${builder_image}" .travis/build-zip.sh

deploy:
  provider: releases
  api_key:
    secure: R7G3PZJ2kmjlK2iWN/a6kwbSaE/zSMWTKdI3CmnJoJHu3/b9X8X6Wlyxeug36EuYw5pCEhi+j9PO4bcRa12VFB5k7fjyMBHrwEv4sNiONkyeSJMRtD4FpM/qxHRM1L5ZARtMowm+U9IkGvvJ92hdxq7kMDh01BrYEC1s2ij70BA7jUKdBJNjrPYt9TwlhWN9hzQxjikfJ/7qpQYc9vyi1T6kaLUGvqypv7rpuu2VdW+OoJYwRhxoxDT9EglSLnFcH1v2g020xi88V0XZ2Dkej+cTjLN5FOhEh25Zn0OUjLgi/15CJn1Febk/+PeA1DzTQtWRxFgWH2YJrC/RBBbT/bGSb46yCPP0aNSxYw5jLIf1YVxEtLixqaS4EBnj+NVIwZIORSjrXm34RGkIxqxvcyCmNfCa3rEnDTpw2+WHiWnhW+FRjiLRgSujhjEtFo00ET1fD9Bqp6fhTBcFTyzsF/gnHELcksG+992WM9V4T8rdG7+ASafKqQ9AqXO98Csy6c81+X3HU16ZQbFp3aKQHqqZgxeNYjFHQ0w+GXkgvlBWqISTVgRuO7LSE9bZos3JtZz1fG/7HDqRFJ4UkRKewsQyeNxBNCFy4ikgHrrsLy/6Bx5yKdr80YBTgfyBISBymTpP68GB2nBJHUuJOIrdpxha+E+3TXE5jYD9+9yuqxY=
  file: 'dist/constellation.zip'
  on:
    repo: constellation-app/constellation
    branch: master
    tags: true
